<html>
  <head>
    <link rel="stylesheet" href="../../css/spectre.min.css">
    <style>
      .container {
        max-width: 400px;
        margin: 0 auto;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <p><b>Thinking of You Setup</b></p>
      <p>Configure your connection to send and receive pings with your partner.</p>
      
      <div class="form-group">
        <label class="form-label">Your Name:</label>
        <input type="text" id="myName" class="form-input" placeholder="Enter your name">
      </div>
      
      <div class="form-group">
        <label class="form-label">Connection Type:</label>
        <label class="form-radio">
          <input type="radio" name="setupType" value="create" checked>
          <i class="form-icon"></i> Create New Connection
        </label>
        <label class="form-radio">
          <input type="radio" name="setupType" value="join">
          <i class="form-icon"></i> Join Existing Connection
        </label>
      </div>
      
      <div id="createSection">
        <div class="form-group">
          <label class="form-label">Your Link Code:</label>
          <p><b><span id="linkCodeDisplay" style="font-size: 24px; letter-spacing: 3px;">------</span></b></p>
          <p>Share this code with your partner</p>
        </div>
        
        <div class="form-group">
          <label class="form-label">Discord Webhook URL (optional):</label>
          <input type="text" id="webhookUrl" class="form-input" placeholder="https://discord.com/api/webhooks/...">
        </div>
      </div>
      
      <div id="joinSection" style="display:none;">
        <div class="form-group">
          <label class="form-label">Partner's Link Code:</label>
          <input type="text" id="partnerLinkCode" class="form-input" placeholder="Enter 6-character code" maxlength="6" style="text-transform: uppercase;">
        </div>
        <p><button id="checkCode" class="btn btn-primary">Check Code</button></p>
        
        <div id="nameSelectionSection" style="display:none;">
          <p>Found existing connection! Select your name:</p>
          <div id="nameButtons"></div>
        </div>
      </div>
      
      <p id="errorMessage" style="color: red; display: none;"></p>
      
      <p>Click <button id="upload" class="btn btn-primary">Upload</button></p>
    </div>
    
    <script src="../../core/lib/customize.js"></script>
    <script>
      (function() {
        try {
          const API_ENDPOINT = 'https://mute-elsinore-pokyplays-01040d8f.koyeb.app/api';
          
          function generateLinkCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
              code += chars[Math.floor(Math.random() * chars.length)];
            }
            return code;
          }
          
          let currentSettings = {};
          try {
            const stored = localStorage.getItem('thinkingofyou_settings');
            if (stored) currentSettings = JSON.parse(stored);
          } catch (e) {
            console.log('Could not load settings:', e);
          }
          
          if (!currentSettings.linkCode) {
            currentSettings.linkCode = generateLinkCode();
          }
          
          document.getElementById('myName').value = currentSettings.myName || '';
          document.getElementById('linkCodeDisplay').textContent = currentSettings.linkCode;
          document.getElementById('webhookUrl').value = currentSettings.webhookUrl || '';
          
          document.querySelectorAll('input[name="setupType"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
              if (this.value === 'create') {
                document.getElementById('createSection').style.display = 'block';
                document.getElementById('joinSection').style.display = 'none';
              } else {
                document.getElementById('createSection').style.display = 'none';
                document.getElementById('joinSection').style.display = 'block';
              }
            });
          });
          
          document.getElementById('partnerLinkCode').addEventListener('input', function(e) {
            this.value = this.value.toUpperCase();
            document.getElementById('nameSelectionSection').style.display = 'none';
          });
          
          document.getElementById('checkCode').addEventListener('click', function() {
            const code = document.getElementById('partnerLinkCode').value.trim().toUpperCase();
            const errorMsg = document.getElementById('errorMessage');
            
            if (code.length !== 6) {
              errorMsg.textContent = 'Please enter a valid 6-character link code';
              errorMsg.style.display = 'block';
              return;
            }
            
            errorMsg.style.display = 'none';
            
            fetch(API_ENDPOINT + '/whoIsRegistered?linkCode=' + code)
              .then(function(response) { return response.json(); })
              .then(function(data) {
                if (!data.exists || data.registeredNames.length === 0) {
                  errorMsg.textContent = 'No one has registered with this code yet';
                  errorMsg.style.display = 'block';
                  return;
                }
                
                const nameButtons = document.getElementById('nameButtons');
                nameButtons.innerHTML = '';
                
                data.registeredNames.forEach(function(name) {
                  const btn = document.createElement('button');
                  btn.className = 'btn';
                  btn.textContent = name;
                  btn.style.marginRight = '5px';
                  btn.style.marginBottom = '5px';
                  btn.onclick = function() {
                    document.getElementById('myName').value = name;
                    document.querySelectorAll('#nameButtons .btn').forEach(function(b) {
                      b.classList.remove('btn-primary');
                    });
                    btn.classList.add('btn-primary');
                  };
                  nameButtons.appendChild(btn);
                });
                
                document.getElementById('nameSelectionSection').style.display = 'block';
              })
              .catch(function(error) {
                errorMsg.textContent = 'Error checking link code. Please try again.';
                errorMsg.style.display = 'block';
              });
          });
          
          document.getElementById('upload').addEventListener('click', function() {
            const myNameInput = document.getElementById('myName').value.trim();
            const setupType = document.querySelector('input[name="setupType"]:checked').value;
            const errorMsg = document.getElementById('errorMessage');
            
            if (!myNameInput) {
              errorMsg.textContent = 'Please enter your name';
              errorMsg.style.display = 'block';
              return;
            }
            
            let partnerLinkCode = '';
            let webhookUrlValue = '';
            
            if (setupType === 'join') {
              partnerLinkCode = document.getElementById('partnerLinkCode').value.trim().toUpperCase();
              if (partnerLinkCode.length !== 6) {
                errorMsg.textContent = 'Please enter a valid 6-character link code';
                errorMsg.style.display = 'block';
                return;
              }
            } else {
              webhookUrlValue = document.getElementById('webhookUrl').value.trim();
            }
            
            const settings = {
              myName: myNameInput,
              webhookUrl: webhookUrlValue,
              linkCode: setupType === 'join' ? partnerLinkCode : currentSettings.linkCode,
              isConfigured: true
            };
            
            localStorage.setItem('thinkingofyou_settings', JSON.stringify(settings));
            
            sendCustomizedApp({
              storage: [
                {
                  name: "thinkingofyou.json",
                  content: JSON.stringify(settings)
                }
              ]
            });
          });
        } catch (e) {
          console.error('Error in custom.html:', e);
          alert('Error loading configuration: ' + e.message);
        }
      })();
    </script>
  </body>
</html>
