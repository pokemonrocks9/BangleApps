<html>
  <head>
    <link rel="stylesheet" href="../../css/spectre.min.css">
  </head>
  <body>
    <h3>Thinking of You Configuration</h3>
    <p>Click the button below to configure your connection settings.</p>
    <p><button id="configure" class="btn btn-primary">Open Configuration</button></p>
    <p id="status"></p>
    
    <script src="../../core/lib/customize.js"></script>
    <script>
      const CONFIGURL = "https://pokemonrocks9.github.io/thinking-of-you-config/";
      
      // Read existing settings from the watch
      Puck.eval('require("Storage").readJSON("thinkingofyou.json", true)', function(settings) {
        if (!settings) settings = {};
        
        // Generate link code if it doesn't exist
        if (!settings.linkCode) {
          const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
          let code = '';
          for (let i = 0; i < 6; i++) {
            code += chars[Math.floor(Math.random() * chars.length)];
          }
          settings.linkCode = code;
        }
        
        // Build URL with current settings
        const url = CONFIGURL + '?' + 
                    'linkCode=' + encodeURIComponent(settings.linkCode || '') +
                    '&myName=' + encodeURIComponent(settings.myName || '') +
                    '&partnerName=' + encodeURIComponent(settings.partnerName || '') +
                    '&webhookUrl=' + encodeURIComponent(settings.webhookUrl || '');
        
        let configWindow;
        
        // Listen for messages from the config window
        window.addEventListener('message', function(event) {
          if (event.data && event.data.type === 'ok') {
            const newSettings = event.data.data;
            handleConfigReturn(newSettings, settings);
          }
        });
        
        // Open configuration window
        document.getElementById("configure").addEventListener("click", function() {
          document.getElementById("status").textContent = "Opening configuration...";
          configWindow = window.open(url, '_blank', 'width=500,height=700');
          
          // Poll for hash changes (fallback method)
          const checkInterval = setInterval(function() {
            if (configWindow && configWindow.closed) {
              clearInterval(checkInterval);
              document.getElementById("status").textContent = "Configuration window closed.";
            }
            
            try {
              if (configWindow && configWindow.location.hash) {
                const hash = configWindow.location.hash.substring(1);
                if (hash) {
                  const newSettings = JSON.parse(decodeURIComponent(hash));
                  handleConfigReturn(newSettings, settings);
                  clearInterval(checkInterval);
                  configWindow.close();
                }
              }
            } catch (e) {
              // Cross-origin, can't access - that's fine
            }
          }, 500);
        });
        
        function handleConfigReturn(newSettings, currentSettings) {
          document.getElementById("status").textContent = "Saving settings...";
          
          // Update settings
          if (newSettings.myName) {
            currentSettings.myName = newSettings.myName;
          }
          
          if (newSettings.partnerName) {
            currentSettings.partnerName = newSettings.partnerName;
          }
          
          if (newSettings.webhookUrl !== undefined) {
            currentSettings.webhookUrl = newSettings.webhookUrl;
          }
          
          if (newSettings.partnerLinkCode) {
            currentSettings.linkCode = newSettings.partnerLinkCode;
          }
          
          currentSettings.isConfigured = (currentSettings.myName !== '' && currentSettings.myName !== undefined);
          
          // Write back to watch
          Puck.write('require("Storage").writeJSON("thinkingofyou.json", ' + JSON.stringify(currentSettings) + ');\n', function() {
            document.getElementById("status").innerHTML = "<strong style='color: green;'>âœ“ Settings saved successfully!</strong>";
          });
        }
      });
    </script>
  </body>
</html>
